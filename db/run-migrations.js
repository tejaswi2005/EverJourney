import fs from 'fs';
import path from 'path';
import { Pool } from 'pg';
import dotenv from 'dotenv';
import { fileURLToPath } from 'url';

dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const MIGRATIONS_DIR = path.join(__dirname, 'migrations');

// Use env from .env (either a full DATABASE_URL or PG* vars)
const pool = new Pool({
  connectionString: process.env.DATABASE_URL || process.env.PG_URI, // optional
  host: process.env.PGHOST || 'localhost',
  port: process.env.PGPORT ? Number(process.env.PGPORT) : 5432,
  database: process.env.PGDATABASE || 'everjourney',
  user: process.env.PGUSER || 'everjourney_user',
  password: process.env.PGPASSWORD || 'StrongLocalPass#123',
  ssl: process.env.PGSSLMODE === 'require' ? { rejectUnauthorized: false } : undefined
});

async function ensureMigrationsTable(client) {
  await client.query(`
    CREATE TABLE IF NOT EXISTS schema_migrations (
      id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      filename TEXT UNIQUE NOT NULL,
      applied_at timestamptz NOT NULL DEFAULT now()
    );
  `);
}

async function alreadyApplied(client, filename) {
  const { rows } = await client.query(
    'SELECT 1 FROM schema_migrations WHERE filename = $1',
    [filename]
  );
  return rows.length > 0;
}

(async () => {
  const client = await pool.connect();
  try {
    await ensureMigrationsTable(client);

    const files = fs.readdirSync(MIGRATIONS_DIR)
      .filter(f => f.endsWith('.sql'))
      .sort(); // ensures 001_*, 002_* order

    for (const file of files) {
      if (await alreadyApplied(client, file)) {
        console.log('↷  skip', file);
        continue;
      }

      const sql = fs.readFileSync(path.join(MIGRATIONS_DIR, file), 'utf8');
      console.log('▶  apply', file);
      try {
        await client.query('BEGIN');
        await client.query(sql);
        await client.query('INSERT INTO schema_migrations(filename) VALUES ($1)', [file]);
        await client.query('COMMIT');
        console.log('✔  done', file);
      } catch (e) {
        await client.query('ROLLBACK');
        console.error('✖  failed', file);
        console.error(e.message);
        process.exit(1);
      }
    }
    console.log('All migrations applied.');
    process.exit(0);
  } catch (e) {
    console.error(e);
    process.exit(1);
  } finally {
    client.release();
    await pool.end();
  }
})();
